# ğŸ¯ GPU SSH Gateway

ê´€ë¦¬ìê°€ APIë¡œ íŠ¹ì • ì‚¬ìš©ì ì „ìš© ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•˜ë©´, ì‚¬ìš©ìê°€ `ssh user123@ssh.gw` ëª…ë ¹ìœ¼ë¡œ ì ‘ì†í•´ MIG GPU ë¦¬ì†ŒìŠ¤ì™€ ì˜êµ¬ ë³¼ë¥¨ì´ ìë™ í• ë‹¹ëœ ê°œë³„ í™˜ê²½ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” SSH ê²Œì´íŠ¸ì›¨ì´ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

## ğŸš€ ì£¼ìš” ê¸°ëŠ¥

- **GPU MIG ì¸ìŠ¤í„´ìŠ¤ ë™ì  í• ë‹¹ ë° íšŒìˆ˜**
- **ë³¼ë¥¨ ë§ˆìš´íŠ¸ ë° ê²©ë¦¬ëœ ì»¨í…Œì´ë„ˆ ìƒì„±**  
- **ë‹¨ì¼ SSH ì§„ì…ì ì—ì„œ ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆë¡œ ë¼ìš°íŒ…** (SSHPiper)
- **ì„¸ì…˜ ìë™ ì¢…ë£Œ / ê´€ë¦¬** (TTL)

## ğŸ“¦ ì‹œìŠ¤í…œ êµ¬ì„±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    SSH     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ‘¤ ì‚¬ìš©ì      â”‚ â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ ğŸ”€ SSHPiper     â”‚
â”‚ ssh user@ssh.gw â”‚           â”‚   Gateway       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             ğŸ§  Orchestrator ë°ëª¬                         â”‚
â”‚  â€¢ ì„¸ì…˜ ê´€ë¦¬  â€¢ GPU/MIG í• ë‹¹  â€¢ pipe.yaml ë™ê¸°í™”        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ³ Docker Engineâ”‚    â”‚ ğŸ“¦ NVML ë¼ì´ë¸ŒëŸ¬ë¦¬â”‚    â”‚ ğŸ’¾ Host ë³¼ë¥¨     â”‚
â”‚+ NVIDIA ëŸ°íƒ€ì„   â”‚    â”‚(GPU & MIG ì •ë³´) â”‚    â”‚/srv/workspaces/ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ğŸ“¦ Session ì»¨í…Œì´ë„ˆ                         â”‚
â”‚  â€¢ OpenSSH  â€¢ GPU/MIG í• ë‹¹  â€¢ ì „ìš© ë³¼ë¥¨ ë§ˆìš´íŠ¸          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ› ï¸ ì„¤ì¹˜ ë° ì‹¤í–‰

### ì‚¬ì „ ìš”êµ¬ì‚¬í•­

- Docker Engine 24.0+ with NVIDIA Container Runtime
- NVIDIA Driver 535+ with MIG ì§€ì›
- Go 1.21+ (ê°œë°œ ì‹œ)

### 1. í”„ë¡œì íŠ¸ í´ë¡ 

```bash
git clone https://github.com/sandman/gpu-ssh-gateway.git
cd gpu-ssh-gateway
```

### 2. ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ë¯¸ì§€ ë¹Œë“œ

```bash
docker build -f Dockerfile.gpu-workspace -t gpu-workspace .
```

### 3. ì‹œìŠ¤í…œ ì‹œì‘

```bash
# í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„±
sudo mkdir -p /srv/workspaces /var/lib/orchestrator /etc/sshpiper

# Docker Composeë¡œ ì‹¤í–‰
docker-compose up -d
```

## ğŸ“– API ì‚¬ìš©ë²•

### ì„¸ì…˜ ìƒì„±

```bash
curl -X POST http://localhost:8080/sessions \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user123",
    "ttl_minutes": 60,
    "mig_profile": "3g.20gb"
  }'
```

**ì‘ë‹µ:**
```json
{
  "session_id": "abc-123-def",
  "container_id": "container123",
  "ssh_user": "user123",
  "ssh_host": "ssh.gw",
  "ssh_port": 22,
  "gpu_uuid": "MIG-GPU-3e9c/3/0",
  "created_at": "2025-01-17T08:00:00Z",
  "expires_at": "2025-01-17T09:00:00Z"
}
```

### SSH ì ‘ì†

```bash
ssh user123@ssh.gw
```

### ì„¸ì…˜ ì¡°íšŒ

```bash
curl http://localhost:8080/sessions/abc-123-def
```

### ì„¸ì…˜ ì‚­ì œ

```bash
curl -X DELETE http://localhost:8080/sessions/abc-123-def
```

### GPU ì •ë³´ ì¡°íšŒ

```bash
curl http://localhost:8080/gpus
```

### ì§€ì›ë˜ëŠ” MIG í”„ë¡œíŒŒì¼ ì¡°íšŒ

```bash
curl http://localhost:8080/gpus/profiles
```

## ğŸ® ì§€ì›ë˜ëŠ” MIG í”„ë¡œíŒŒì¼

| í”„ë¡œíŒŒì¼    | GPU ìŠ¬ë¼ì´ìŠ¤ | ë©”ëª¨ë¦¬    | ì‚¬ìš© ì‚¬ë¡€           |
|----------|----------|--------|-----------------|
| `1g.5gb` | 1        | 5GB    | ê°€ë²¼ìš´ ê°œë°œ/í…ŒìŠ¤íŠ¸     |
| `2g.10gb`| 2        | 10GB   | ì¤‘ê°„ ê·œëª¨ í›ˆë ¨       |
| `3g.20gb`| 3        | 20GB   | ì¼ë°˜ì ì¸ ë”¥ëŸ¬ë‹ ì›Œí¬ë¡œë“œ  |
| `4g.20gb`| 4        | 20GB   | í° ëª¨ë¸ ì¶”ë¡         |
| `7g.40gb`| 7        | 40GB   | ëŒ€í˜• ëª¨ë¸ í›ˆë ¨/ì¶”ë¡    |

## ğŸ”§ ì„¤ì •

### í™˜ê²½ ë³€ìˆ˜

| ë³€ìˆ˜                   | ê¸°ë³¸ê°’                           | ì„¤ëª…              |
|----------------------|-------------------------------|-----------------|
| `--port`             | `8080`                        | API ì„œë²„ í¬íŠ¸       |
| `--db`               | `/var/lib/orchestrator/sessions.db` | SQLite DB ê²½ë¡œ |
| `--piper-config`     | `/etc/sshpiper/pipe.yaml`    | SSHPiper ì„¤ì • ê²½ë¡œ  |
| `--workspace-root`   | `/srv/workspaces`             | ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ |

### ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
/srv/workspaces/
â”œâ”€â”€ user123/
â”‚   â”œâ”€â”€ .bashrc
â”‚   â”œâ”€â”€ projects/
â”‚   â””â”€â”€ data/
â”œâ”€â”€ user456/
â”‚   â””â”€â”€ ...
```

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

- **ì»¨í…Œì´ë„ˆ ê²©ë¦¬**: `--cap-drop ALL` + `--security-opt no-new-privileges:true`
- **ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬**: `worknet` ì™¸ë¶€ ì ‘ê·¼ ë¶ˆê°€, SSHPiperë§Œ í¬ì›Œë”©
- **GPU ì œí•œ**: `--gpus device=UUID`ë¡œ íŠ¹ì • MIG ì¸ìŠ¤í„´ìŠ¤ë§Œ ì ‘ê·¼
- **í˜¸ìŠ¤íŠ¸ ë³´í˜¸**: ë£¨íŠ¸ ë³¼ë¥¨ ì ‘ê·¼ ì œê±°, ì‚¬ìš©ì ë§ˆìš´íŠ¸ë§Œ í—ˆìš©

## ğŸ§¹ ì„¸ì…˜ ê´€ë¦¬

### TTL ê¸°ë°˜ ìë™ ì •ë¦¬

- **ê¸°ë³¸ TTL**: 60ë¶„
- **ì •ë¦¬ ì£¼ê¸°**: 1ë¶„ë§ˆë‹¤ ë§Œë£Œëœ ì„¸ì…˜ í™•ì¸
- **ì •ë¦¬ ê³¼ì •**:
  1. ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
  2. MIG ì¸ìŠ¤í„´ìŠ¤ í•´ì œ
  3. SSH ë¼ìš°íŒ… ê·œì¹™ ì œê±°
  4. ë°ì´í„°ë² ì´ìŠ¤ ë ˆì½”ë“œ ì‚­ì œ

### ìˆ˜ë™ ì •ë¦¬

```bash
# íŠ¹ì • ì„¸ì…˜ ì¢…ë£Œ
curl -X DELETE http://localhost:8080/sessions/{session_id}

# ëª¨ë“  í™œì„± ì„¸ì…˜ ì¡°íšŒ
curl http://localhost:8080/sessions
```

## ğŸ” ëª¨ë‹ˆí„°ë§

### ë¡œê·¸ í™•ì¸

```bash
# Orchestrator ë¡œê·¸
docker logs gpu-ssh-orchestrator

# SSHPiper ë¡œê·¸  
docker logs sshpiper

# íŠ¹ì • ì‚¬ìš©ì ì»¨í…Œì´ë„ˆ ë¡œê·¸
docker logs user123-container
```

### GPU ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§

```bash
# í˜¸ìŠ¤íŠ¸ì—ì„œ
nvidia-smi

# ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ
nvtop
```

## ğŸš¨ ë¬¸ì œ í•´ê²°

### ì¼ë°˜ì ì¸ ë¬¸ì œ

1. **MIG ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹¤íŒ¨**
   ```bash
   # MIG ëª¨ë“œ í™œì„±í™” í™•ì¸
   nvidia-smi -i 0 --query-gpu=mig.mode.current --format=csv
   
   # MIG ëª¨ë“œ í™œì„±í™” (ì¬ë¶€íŒ… í•„ìš”)
   sudo nvidia-smi -i 0 -mig 1
   ```

2. **SSH ì—°ê²° ì‹¤íŒ¨**
   ```bash
   # SSHPiper ì„¤ì • í™•ì¸
   cat /etc/sshpiper/pipe.yaml
   
   # ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí¬ í™•ì¸
   docker network inspect worknet
   ```

3. **ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨**
   ```bash
   # Docker ë¡œê·¸ í™•ì¸
   docker logs gpu-ssh-orchestrator
   
   # GPU í• ë‹¹ í™•ì¸
   docker run --rm --gpus all nvidia/cuda:12.2-runtime-ubuntu24.04 nvidia-smi
   ```

## ğŸ¤ ê¸°ì—¬

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add some amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## ğŸ“ ë¼ì´ì„ ìŠ¤

ì´ í”„ë¡œì íŠ¸ëŠ” MIT ë¼ì´ì„ ìŠ¤ í•˜ì— ë°°í¬ë©ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ `LICENSE` íŒŒì¼ì„ ì°¸ì¡°í•˜ì„¸ìš”.

## ğŸ“ ì§€ì›

ë¬¸ì œê°€ ìˆê±°ë‚˜ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ GitHub Issuesë¥¼ í†µí•´ ë¬¸ì˜í•´ ì£¼ì„¸ìš”. 